name: Universal AOSP GSI Builder

on:
  workflow_dispatch:
    inputs:
      rom_manifest:
        description: "Manifest ROM (contoh: https://github.com/PixelOS-AOSP/manifest.git)"
        required: true
      rom_branch:
        description: "Branch ROM (contoh: fifteen atau lineage-21)"
        required: true
      rom_name:
        description: "Nama ROM (contoh: PixelOS, LineageOS, EvolutionX)"
        required: true
      maintainer:
        description: "Nama Maintainer"
        required: false
        default: "anothernop"

jobs:
  build:
    name: Build Universal AOSP GSI
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Build Environment + CCACHE + Swap
        run: |
          sudo apt update
          sudo apt install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib \
            git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev \
            liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 \
            libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev \
            openjdk-11-jdk python3 python3-pip wget repo

          # Aktifkan ccache
          export USE_CCACHE=1
          ccache -M 15G
          echo 'export USE_CCACHE=1' >> ~/.bashrc
          echo 'export CCACHE_EXEC=$(which ccache)' >> ~/.bashrc

          # Tambahkan swap 10GB
          sudo fallocate -l 10G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

          # Konfigurasi global git
          git config --global user.name "GSI Builder"
          git config --global user.email "actions@github.com"

      - name: Initialize ROM Source
        run: |
          mkdir rom && cd rom
          repo init -u ${{ github.event.inputs.rom_manifest }} -b ${{ github.event.inputs.rom_branch }}
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle

      - name: Clone PHH Treble Tree
        run: |
          cd rom
          git clone https://github.com/phhusson/treble_manifest.git -b main device/phh/treble
          mkdir -p device/phh/treble
          bash device/phh/treble/patches/apply.sh

      - name: Build GSI Variants
        run: |
          cd rom
          source build/envsetup.sh

          for target in treble_arm64_abN treble_arm64_aN treble_arm_abN treble_a64_abN treble_x86_abN; do
            echo "ðŸ”¨ Building $target..."
            lunch $target-userdebug
            make -j$(nproc) systemimage
            mkdir -p ../../release/$target
            mv out/target/product/$target/system.img ../../release/$target/system.img || true
          done

      - name: Package All Builds
        run: |
          cd release
          echo "ROM: ${{ github.event.inputs.rom_name }}" > info.txt
          echo "Branch: ${{ github.event.inputs.rom_branch }}" >> info.txt
          echo "Maintainer: ${{ github.event.inputs.maintainer }}" >> info.txt
          zip -r ${{ github.event.inputs.rom_name }}-GSI-${{ github.event.inputs.rom_branch }}.zip ./*

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/${{ github.event.inputs.rom_name }}-GSI-${{ github.event.inputs.rom_branch }}.zip
          tag_name: GSI-${{ github.event.inputs.rom_name }}-${{ github.run_number }}
          name: "${{ github.event.inputs.rom_name }} GSI Build #${{ github.run_number }}"
          body: |
            âœ… **${{ github.event.inputs.rom_name }} GSI Build Complete**
            - Maintainer: **${{ github.event.inputs.maintainer }}**
            - Branch: **${{ github.event.inputs.rom_branch }}**
            - Variants: ARM64-AB, ARM64-A, ARM-AB, A64-AB, X86-AB
            - CCACHE: Enabled (15GB)
            - SWAP: 10GB active
            - Build #: ${{ github.run_number }}
            - Built via GitHub Actions ðŸš€
